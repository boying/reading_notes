---
title: 分布式
tags: 分布式
grammar_cjkRuby: true
---


### CAP理论

### 分布式一致性方案

#### 分布式事务

**两阶段提交**

它是协调所有分布式原子事务参与者，并决定提交或取消（回滚）的分布式算法。同时也是解决一致性问题的一致性算法。

在分布式系统里为了保证所有节点在进行事务提交时保持一致性的一种协议算法。

参与者：

在两阶段提交协议中，系统一般包含两类机器（或节点）：一类为协调者（coordinator），通常一个系统中只有一个；另一类为事务参与者（participants，cohorts或workers），一般包含多个，在数据存储系统中可以理解为数据副本的个数。

协议中假设每个节点都会记录写前日志（write-ahead log）并持久性存储，即使节点发生故障日志也不会丢失。协议中同时假设节点不会发生永久性故障而且任意两个节点都可以互相通信。

阶段1：请求阶段（commit-request phase，或称表决阶段，voting phase）

在请求阶段，协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。在表决过程中，参与者将告知协调者自己的决策：同意（事务参与者本地作业执行成功）或取消（本地作业执行故障）。

阶段2：提交阶段（commit phase）

在该阶段，协调者将基于第一个阶段的投票结果进行决策：提交或取消。当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务。参与者在接收到协调者发来的消息后将执行响应的操作。


第一阶段，投票阶段：

1. 协调者会问所有的参与者结点，是否可以执行提交操作。
2. 各个参与者开始事务执行的准备工作：如：为资源上锁，预留资源，写undo/redo log……
3. 参与者响应协调者，如果事务的准备工作成功，则回应“可以提交”，否则回应“拒绝提交”。

第二阶段，提交阶段：

1. 如果所有的参与者都回应“可以提交”，那么，协调者向所有的参与者发送“正式提交”的命令。参与者完成正式提交，并释放所有资源，然后回应“完成”，协调者收集各结点的“完成”回应后结束这个Global Transaction。
2. 如果有一个参与者回应“拒绝提交”，那么，协调者向所有的参与者发送“回滚操作”，并释放所有资源，然后回应“回滚完成”，协调者收集各结点的“回滚”回应后，取消这个Global Transaction。

**优缺点**

优点：实现简单

缺点：对性能影响大，不适合高并发，高性能需求场景。
涉及对此节点间的网络通信，通信时间太长
事务时间变长，锁定的资源的时间也变长了，造成资源等待时间增加


#### 消息队列——最终一致

**思路**

将分布式事务拆分成一系列本地事务。通过消息进行多服务间的通信。

生产消息方
1. 开启事务
2. 本地数据库业务数据操作
3. 添加一条记录到消息消息表
4. 通过MQ发送消息
5. 上述出现异常，回滚，否则，提交事务
6. 收到消费方成功处理消息的回复，删除消息
7. 对于消息表中一直存在的未处理消息，尝试重发

接受消息方
1. 接受消息，判断消息是否已经处理，如果已处理，告知发送发，消息已成功处理
2. 开启事务
3. 本地数据库业务数据操作
4. 提交事务
5. 事务提交成功，告知发送方，消息已成功处理

**注意事项**

消息重复发送情况下，消费方需要保持幂等

**优缺点**

优点：避免了分布式事务，提高了系统的吞吐量，实现了最终一致性。


#### 提供回滚接口

**思路**

服务方提供回滚接口，A、B、C多个服务调用，当某个服务调用失败时，调用之前成功调用的服务的回滚接口

**优缺点**

优点：适用于非常简单的场景，服务容易回滚，依赖的服务也少的情况

缺点：适用场景局限，存在问题（系统崩溃，不执行回滚调用）。代码庞大，耦合性高，串行服务很多，回滚成本高。

#### 补偿方式

在高级别的服务中，加入详细的日志记录，一旦系统内部发生致命异常，会有邮件通知。

定时任务扫描分析日志，尝试通过程序来补偿并通知相关人员。

人工补偿。

### 参考文章

http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency

http://www.cnblogs.com/LBSer/p/4715395.html

http://blog.csdn.net/shenlan211314/article/details/7283948

http://coolshell.cn/articles/10910.html


